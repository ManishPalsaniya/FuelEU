"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ComplianceUseCase = void 0;
const Entities_1 = require("../domain/Entities");
const Formulas_1 = require("../domain/Formulas");
class ComplianceUseCase {
    constructor(complianceRepo, routeRepo, bankingRepo) {
        this.complianceRepo = complianceRepo;
        this.routeRepo = routeRepo;
        this.bankingRepo = bankingRepo;
    }
    async calculateComplianceBalance(shipId, year) {
        // 1. Get Route data for ship & year (Assuming shipId maps to routeId or we search by routeId)
        // The prompt implies shipId is used in compliance/banking, but routes have routeId.
        // Let's assume for this scope that shipId == routeId for simplicity, or we look up route by routeId.
        const route = await this.routeRepo.findByRouteId(shipId);
        if (!route) {
            throw new Error('Ship/Route not found');
        }
        if (route.year !== year) {
            // If route data is specific to a year, we might need to find the route for that year.
            // The repository findByRouteId might need to be specific or we filter.
            // Let's assume the route object passed IS for the correct year or we validate.
        }
        // Calculate CB
        const cbVal = Formulas_1.Formulas.calculateComplianceBalance(route.ghgIntensity, route.fuelConsumption);
        // Check for existing compliance record or create new
        let compliance = await this.complianceRepo.findByShipIdAndYear(shipId, year);
        if (!compliance) {
            compliance = new Entities_1.ComplianceBalance('', // ID generated by DB/Repo
            shipId, year, cbVal, cbVal, // Before banking
            cbVal, // Adjusted (initially same)
            new Date());
        }
        else {
            // Update values if route data changed
            compliance.cbGco2eq = cbVal;
            compliance.cbBeforeBanking = cbVal;
            // Adjusted CB needs to consider banking, which is a separate step or derived.
            // For this method, we return the raw calculation primarily?
            // Let's keep it simple: This method calculates/refreshes the base CB.
        }
        return this.complianceRepo.save(compliance);
    }
    async getAdjustedComplianceBalance(shipId, year) {
        let compliance = await this.complianceRepo.findByShipIdAndYear(shipId, year);
        if (!compliance) {
            // Try to calculate it first
            compliance = await this.calculateComplianceBalance(shipId, year);
        }
        // Apply banking
        const bankRecords = await this.bankingRepo.findByShipIdAndYear(shipId, year);
        let adjustedCb = compliance.cbBeforeBanking;
        for (const record of bankRecords) {
            if (record.transactionType === 'bank') {
                // Banking surplus REDUCES the current year's CB (it moves away)? 
                // Or does it just mean we stored it?
                // Usually: CB > 0 is surplus. If we bank it, we remove it from current year to save for later.
                // So Adjusted = Base - BankedAmount
                adjustedCb -= record.amountGco2eq;
            }
            else if (record.transactionType === 'apply') {
                // Applying banked surplus INCREASES the current year's CB (helping a deficit).
                adjustedCb += record.amountGco2eq;
            }
        }
        compliance.adjustedCb = adjustedCb;
        return this.complianceRepo.save(compliance);
    }
    async getAllShips() {
        const compliances = await this.complianceRepo.findAllShips();
        const routes = await this.routeRepo.findAll();
        return compliances.map(comp => {
            const route = routes.find(r => r.routeId === comp.shipId);
            return {
                id: comp.shipId,
                name: route ? `Ship ${comp.shipId}` : `Ship ${comp.shipId}`,
                vesselType: route?.vesselType || 'Unknown',
                year: comp.year,
                complianceBalance: comp.adjustedCb
            };
        });
    }
}
exports.ComplianceUseCase = ComplianceUseCase;
